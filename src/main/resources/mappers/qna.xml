<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.btsproject.btsproject20221102.repository.qna.QnaRepository">
    <resultMap id="qna_img_files" type="com.btsproject.btsproject20221102.domain.QnaImgFile">
        <result property="id" column="img_id"></result>
        <result property="qna_board_id" column="qna_board_id"></result>
        <result property="origin_name" column="origin_name"></result>
        <result property="temp_name" column="temp_name"></result>
    </resultMap>
    <resultMap id="qna" type="com.btsproject.btsproject20221102.domain.Qna">
        <result property="id" column="id"></result>
        <result property="menu_id" column="menu_id"></result>
        <result property="category_id" column="category_id"></result>
        <result property="category_sub_id" column="category_sub_id"></result>
        <result property="status_id" column="status_id"></result>
        <result property="user_id" column="user_id"></result>
        <result property="title" column="title"></result>
        <result property="content" column="content"></result>
        <result property="price" column="price"></result>
        <result property="create_date" column="create_date"></result>
        <result property="update_date" column="update_date"></result>
        <collection property="qna_img_files" javaType="list" resultMap="qna_img_files"></collection>
    </resultMap>

    <insert id="saveQna" parameterType="com.btsproject.btsproject20221102.domain.User" useGeneratedKeys="true" keyProperty="id">
<!--       쿼리 어떻게 짜야되는지 질문-->
        insert into
            qna_board_mst
        values(
        0,
<!--        #{menu_id},-->
        1,
        #{category_id},
        #{category_sub_id},
<!--        #{status_id},-->
        1,
<!--        #{user_id},-->
        0,
        #{title},
        #{info},
        #{want_info},
        #{price},
        now(),
        now()
        );
    </insert>

    <insert id="saveImgFiles" parameterType="java.util.List">
        insert into
            qna_board_img
        values
        <foreach item="file" collection="list" separator=",">
            (
                0,
                #{file.qna_board_id},
                #{file.origin_name},
                #{file.temp_name},
                now(),
                now()
            )
        </foreach>


    </insert>
    
<!--    <select id="infoQna" parameterType="Integer" resultMap="com.btsproject.btsproject20221102.dto.board.QnaCreateRespDto">-->
<!--        select-->
<!--            qm.id,-->
<!--            qm.menu_id,-->
<!--            qm.category_id,-->
<!--            qm.category_sub_id,-->
<!--            qm.status_id,-->
<!--            qm.user_id,-->
<!--            qm.title,-->
<!--            qm.info,-->
<!--            qm.want_info,-->
<!--            qm.price,-->
<!--            qm.create_date,-->
<!--            qm.update_date,-->
<!--            qim.id AS img_id,-->
<!--            qim.qna_board_id,-->
<!--            qim.origin_name,-->
<!--            qim.temp_name-->
<!--        from-->
<!--            (select-->
<!--            *-->
<!--            from-->
<!--                qna_board_mst-->
<!--            limit #{index},10) qm-->
<!--            left outer join qna_board_img qim on(qim.qna_board_id = qm.id);-->
<!--    </select>-->

    <select id="infoQna" parameterType="Integer" resultType="com.btsproject.btsproject20221102.domain.QnaArticle">
        select
            id,
            menu_id,
            category_id,
            category_sub_id,
            status_id,
            user_id,
            title,
            info,
            want_info,
            price,
            create_date,
            update_date
        from
            qna_board_mst
        where
            id = #{id}
    </select>
<!--    <select id="qnaLoadBoard"-->
<!--            parameterType="hashmap"-->
<!--            resultType="com.btsproject.btsproject20221102.domain.QnaLoadList"-->
<!--    >-->
<!--        SELECT-->
<!--            qbm.user_id,-->
<!--            um.nickname,-->
<!--            um.user_img,-->

<!--            qbm.id,-->
<!--            qbm.title,-->
<!--&lt;!&ndash;            bm.view_count,&ndash;&gt;-->
<!--            qbm.create_date,-->

<!--            cd.category_name,-->
<!--            sd.subcategory_name,-->


<!--            ifnull(pc.total_count,0)-->
<!--        from-->
<!--            qna_board_mst qbm-->
<!--            LEFT OUTER JOIN user_mst um ON(um.id = qbm.user_id)-->
<!--            LEFT OUTER JOIN category_dtl cd ON (cd.id = qbm.category_id)-->
<!--            LEFT OUTER JOIN subcategory_dtl sd ON (sd.id = qbm.category_sub_id)-->
<!--            LEFT OUTER JOIN (SELECT-->
<!--                                COUNT(*) AS total_count-->
<!--                            from-->
<!--                                board_mst-->
<!--                            where-->
<!--                                menu_id = #{menu_id}-->
<!--                            <if test='subcategory_id != "99"'>-->
<!--                                and category_sub_id = #{category_sub_id}-->
<!--                            </if>-->
<!--                            ) pc ON (1=1)-->
<!--        WHERE-->
<!--                qbm.menu_id = #{menu_id}-->
<!--            <if test="category_id != 99">-->
<!--                and qbm.category_id = #{category_id}-->
<!--            </if>-->
<!--            <if test="subcategory_id != 99">-->
<!--                and qbm.category_sub_id = #{category_sub_id}-->
<!--            </if>-->
<!--            <if test='searchValue != null || searchValue !=""'>-->
<!--                and (um.nickname like concat('%', #{searchValue}, '%') or qbm.title like concat('%', #{searchValue}, '%'))-->
<!--            </if>-->

<!--            <if test='show_list == "1"'>-->
<!--                ORDER BY qbm.create_date DESC-->
<!--            </if>-->
<!--            <if test='show_list == "2"'>-->
<!--                ORDER BY lm.like_count DESC-->
<!--            </if>-->
<!--            <if test='show_list == "3"'>-->
<!--                ORDER BY qbm.view_count DESC-->
<!--            </if>-->


<!--        limit-->
<!--            #{page},10-->
<!--    </select>-->
    <select id="qnaLoadBoard"
            parameterType="hashmap"
            resultType="com.btsproject.btsproject20221102.domain.QnaLoadList"
    >
    select
        qbm.user_id,
        ifnull(um.nickname, 0),
        ifnull(um.user_img, 0),
        qbm.id,
        qbm.title,
        qbm.price,
        qbm.status_id,
        ifnull(qbm.view_count, 0),
        qbm.create_date,
        cd.category_name,
        sd.subcategory_name,
        ifnull(cm.comment_count,0),
        ifnull(rm.recomment_count,0),
        ifnull(lm.like_count,0)
<!--        /* 	total_count */-->
    from
        qna_board_mst qbm
        LEFT OUTER JOIN user_mst um ON(um.id = qbm.user_id)
        LEFT OUTER JOIN category_dtl cd ON(cd.id = qbm.category_id)
        LEFT OUTER JOIN subcategory_dtl sd ON(sd.id = qbm.category_sub_id)
        LEFT OUTER JOIN (select
                            board_id,
                            COUNT(*) AS comment_count
                        from
                            comment_mst
                        GROUP BY
                            board_id) cm ON (cm.board_id = qbm.id)
    LEFT OUTER JOIN (select
                            comment_id,
                            COUNT(*) AS recomment_count
                        from
                            recomment_mst
                        GROUP BY
                            comment_id) rm ON (rm.comment_id = cm.board_id)
    LEFT OUTER JOIN (select
                        board_id,
                        COUNT(*) AS like_count
                    from
                        like_mst
                    GROUP BY
                        board_id) lm ON (lm.board_id = qbm.id)
<!--    WHERE-->
<!--        <if test="category_id != 99">-->
<!--            and qbm.category_id = #{category_id}-->
<!--        </if>-->
<!--        <if test="subcategory_id != 99">-->
<!--            and qbm.category_sub_id = #{subcategory_id}-->
<!--        </if>-->
<!--        <if test='searchValue != null || searchValue !=""'>-->
<!--            and (um.nickname like concat('%', #{searchValue}, '%') or qbm.title like concat('%', #{searchValue}, '%'))-->
<!--        </if>-->

<!--        <if test='show_list == "1"'>-->
<!--            ORDER BY qbm.create_date DESC-->
<!--        </if>-->
<!--        <if test='show_list == "2"'>-->
<!--            ORDER BY lm.like_count DESC-->
<!--        </if>-->
<!--        <if test='show_list == "3"'>-->
<!--            ORDER BY qbm.view_count DESC-->
<!--        </if>-->


    limit
    #{page},10


    </select>

</mapper>